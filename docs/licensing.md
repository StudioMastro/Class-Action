---
description: Complete documentation of the licensing system implementation and business logic
globs: ['src/services/licenseService.ts', 'src/components/License*.tsx', 'src/__tests__/**/*.ts']
alwaysApply: false
---

# Figma Plugin Licensing System Documentation

## Overview

This document serves as the single source of truth for all information related to the licensing system in the Figma Plugin Project. It covers the business model, technical implementation, testing strategy, and maintenance guidelines.

## Table of Contents

1. [Business Model](#business-model)
2. [Technical Implementation](#technical-implementation)
3. [Configuration Management](#configuration-management)
4. [Testing Strategy](#testing-strategy)
5. [Security Considerations](#security-considerations)
6. [Best Practices](#best-practices)
7. [Maintenance](#maintenance)
8. [Instance ID Management](#instance-id-management)
9. [Test Structure and Execution](#test-structure-and-execution)
10. [Troubleshooting](#troubleshooting)

## Business Model

### License Tiers

The system supports two license tiers:

- **Free**: Limited features
- **Premium**: All features

Feature flags for each tier are defined in `src/config/featureFlags.ts`.

### License Lifecycle

1. **Activation**: User enters a license key, which is activated via the LemonSqueezy API
2. **Validation**: The license is validated on each plugin start
3. **Deactivation**: User can deactivate the license to use it on another device

## Technical Implementation

### Architecture

The licensing system consists of the following components:

#### Configuration

- `src/config/lemonSqueezy.ts`: Main configuration for the LemonSqueezy API
- `src/config/lemonSqueezyEndpoints.ts`: API endpoints configuration
- `src/config/lemonSqueezyParams.ts`: Parameters configuration for API requests
- `src/config/storage.ts`: Storage keys for client-side storage
- `src/config/featureFlags.ts`: Feature flags for different license tiers

#### Services

- `src/services/licenseService.ts`: Main service for license management
- `src/services/licenseManager.ts`: High-level API for license management
- `src/services/storageService.ts`: Service for data persistence
- `src/services/logger.ts`: Logging service for debugging

#### Utilities

- `src/utils/licenseRequestUtils.ts`: Utilities for building API requests

#### Tests

- `src/__tests__/unit/licenseService.test.ts`: Unit tests for the license service
- `src/__tests__/diagnostics/runEndpointTest.ts`: Test for API endpoints
- `src/__tests__/diagnostics/test-instances.js`: Test for instance_id management
- `src/__tests__/diagnostics/test-lemonsqueezy.js`: Integrated connectivity test used by the plugin

### API Endpoints

The system uses the following LemonSqueezy API endpoints:

- **Activation**: `https://api.lemonsqueezy.com/v1/licenses/activate`
- **Validation**: `https://api.lemonsqueezy.com/v1/licenses/validate`
- **Deactivation**: `https://api.lemonsqueezy.com/v1/licenses/deactivate`

> **Note**: Previously, a CORS proxy (`api-cors-anywhere.lemonsqueezy.com`) was used, but it was removed due to connection issues. Now the plugin directly uses the LemonSqueezy API endpoints.

## Instance ID Management

The `instance_id` is a unique identifier generated by LemonSqueezy when a license is activated on a specific device. It is essential for the licensing system and is automatically managed by the `LicenseService`.

### Instance ID Lifecycle

1. **Generation**: When a user activates a license, LemonSqueezy generates a unique `instance_id` for that license-device combination.

2. **Storage**: The `LicenseService` automatically saves the `instance_id` in Figma's client storage.

3. **Usage**: The `instance_id` is automatically used for:

   - License validation
   - License deactivation

4. **Deletion**: When a license is deactivated, the `instance_id` is removed from storage.

### Implementation

```typescript
// Activation (generates and saves the instance_id)
const result = await licenseService.handleActivate('YOUR_LICENSE_KEY', true);
// The instance_id is now saved internally

// Validation (uses the saved instance_id)
const validationResult = await licenseService.handleValidate('YOUR_LICENSE_KEY', true);

// Deactivation (uses the saved instance_id)
await licenseService.handleDeactivation();
```

### Important Notes

- Users should never manually manage the `instance_id`
- A license can have an activation limit (usually 1)
- To activate a license on a new device, it must first be deactivated on the current device
- If the `instance_id` is lost (e.g., if the user clears browser data), the license must be deactivated from the LemonSqueezy admin panel before it can be reactivated

## Configuration Management

### Environment Configuration

The system supports different environments through the `ENV_CONFIG` object:

```typescript
export const ENV_CONFIG: EnvironmentConfig = {
  isDevelopment: process.env.NODE_ENV === 'development',
  logLevel: 'info',
};
```

### LemonSqueezy Configuration

LemonSqueezy API configuration is stored in the `LEMONSQUEEZY_CONFIG` object:

```typescript
export const LEMONSQUEEZY_CONFIG: LemonSqueezyConfig = {
  API_KEY: process.env.LEMONSQUEEZY_API_KEY || '',
  API_ENDPOINT: 'https://api.lemonsqueezy.com/v1',
  LICENSE_API_ENDPOINT: 'https://api.lemonsqueezy.com/v1/licenses',
  STORE_ID: process.env.LEMONSQUEEZY_STORE_ID || '',
  PRODUCT_ID: process.env.LEMONSQUEEZY_PRODUCT_ID || '',
};
```

## Testing Strategy

### Test Structure

The tests are organized in a structured way:

```
src/__tests__/
├── unit/                 # Unit tests
│   └── licenseService.test.ts
├── integration/          # Integration tests
│   └── (future integration tests)
├── diagnostics/          # Diagnostic tests and utilities
│   ├── runEndpointTest.ts
│   ├── test-instances.js
│   ├── test-lemonsqueezy.js
│   └── README.md
└── mocks/                # Mocks for tests
    └── licenseResponses.ts
```

### Unit Tests

Unit tests verify the functionality of individual components in isolation:

```typescript
// Example unit test for license validation
test('should validate a license successfully', async () => {
  // Mock the API response
  mockFetch.mockResolvedValueOnce({
    ok: true,
    json: () => Promise.resolve(validLicenseResponse),
  });

  // Call the method
  const result = await licenseService.handleValidate('test-license-key');

  // Verify the result
  expect(result.isValid).toBe(true);
  expect(result.tier).toBe('premium');
});
```

## Test Structure and Execution

### Test File Naming Conventions

The project contains two types of test files with different naming conventions:

1. **Unit Tests (`.test.ts`)**:

   - Example: `licenseService.test.ts`
   - These are automated tests executed with Jest
   - They follow the standard Jest convention with the `.test.ts` extension
   - They are automatically executed with the `npm test` command
   - They contain structured tests with `describe` and `it`

2. **Diagnostic Scripts (with "Test" in the name)**:
   - Example: `runEndpointTest.ts`
   - These are manually executable scripts for diagnostics
   - They have the word "Test" in the file name, not in the extension
   - They are executed manually with `npx ts-node`
   - They are used to verify connectivity with external APIs or to diagnose problems

This distinction is intentional and helps separate automated tests from diagnostic tools.

### Running Tests

To run all tests:

```bash
npm test
```

To run a single test file:

```bash
npm test -- src/__tests__/unit/licenseService.test.ts
```

### Diagnostic Tests

Diagnostic tests verify connectivity and integration with the LemonSqueezy API:

#### 1. Connectivity Test (test-connectivity.js)

This script verifies connectivity with LemonSqueezy endpoints using direct endpoints.

```bash
# Basic usage
node src/__tests__/diagnostics/test-connectivity.js
```

#### 2. Instance ID Management Test (test-instances.js)

This script simulates the complete lifecycle of a license, focusing on the management of the `instance_id` in the `licenseService`.

```bash
node src/__tests__/diagnostics/test-instances.js
```

#### 3. Integrated Connectivity Test (test-lemonsqueezy.js)

This script contains functions to test connectivity with the LemonSqueezy API and the format of requests. It is used directly by the plugin to run diagnostic tests on demand.

Unlike the other scripts, this is not intended to be run manually, but is called by the plugin when the user requests a diagnostic test.

### Mocks

The `mocks` directory contains test data and mocks to simulate API responses and other external data. These mocks can be imported into tests to avoid real API calls during testing.

## Security Considerations

### API Key Protection

The LemonSqueezy API key is sensitive and should be protected:

- Store it in environment variables
- Never expose it in client-side code
- Use the CORS proxy for client-side requests

### Data Storage

License data is stored securely in Figma's client storage:

- Data is encrypted by Figma
- Data is only accessible to the plugin
- Data is isolated per user

## Best Practices

### Error Handling

Proper error handling is essential for a good user experience:

```typescript
try {
  // Attempt to validate the license
  const status = await licenseService.handleValidate(licenseKey);
  // Handle success
} catch (error) {
  // Handle error
  console.error('Error validating license:', error);
  // Show user-friendly error message
  showNotification('Failed to validate license. Please try again later.');
}
```

### Logging

Use the logger for consistent logging:

```typescript
import { logger } from '../services/logger';

logger.debug('Debug message');
logger.info('Info message');
logger.warn('Warning message');
logger.error('Error message', { error: 'details' });
```

## Maintenance

### Adding New Features

To add a new feature flag:

1. Add the feature to `src/config/featureFlags.ts`
2. Update the `FEATURE_FLAGS` object with the new feature
3. Set the appropriate value for each license tier

## Troubleshooting

### Common Issues

1. **404 Not Found**: The API endpoint may be incorrect or the license key doesn't exist
2. **401 Unauthorized**: The API key is invalid or missing
3. **403 Forbidden**: The API key doesn't have permission to access the resource
4. **400 Bad Request**: The request is malformed or the license has reached its activation limit

### Specific Errors

- **Error 400 "This license key has reached the activation limit"**: The license is already activated on another device. Deactivate it before reactivating it.
- **Error 404 "license_key not found"**: The provided license key is not valid or does not exist.
- **Error 401 "Unauthenticated"**: The provided API key is not valid or has expired.

## Usage Examples

### Activating a License

```typescript
import { licenseService } from '../services/licenseService';

// Activate a license
const result = await licenseService.handleActivate('your-license-key', true);
if (result.isValid) {
  console.log('License activated successfully!');
}
```

### Validating a License

```typescript
import { licenseService } from '../services/licenseService';

// Validate a license
const result = await licenseService.handleValidate('your-license-key', true);
if (result.isValid) {
  console.log('License is valid!');
}
```

### Deactivating a License

```typescript
import { licenseService } from '../services/licenseService';

// Deactivate a license
await licenseService.handleDeactivation();
console.log('License deactivated!');
```

## References

- [LemonSqueezy API Documentation](https://docs.lemonsqueezy.com/api)
- [LemonSqueezy License API](https://docs.lemonsqueezy.com/api/license-api)
- [Figma Plugin API Documentation](https://www.figma.com/plugin-docs/api/properties/figma-clientStorage/)
